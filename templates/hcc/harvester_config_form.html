{% load crispy_forms_tags %}

<div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
        <div class="modal-header">
            <h4 class="modal-title"> {{ hname }} Harvester Configuration</h4>
            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
        </div>
        <form id="harvester-config-form" class="form-horizontal" action="{% url 'config-harvester' name=hname %}" method="POST">
        <div class="modal-body">
        {% if form %}
            {% csrf_token %}
            {{ form|crispy }}
        {% else %}
            {{ message }}
        {% endif %}
        </div>
        {% if form %} 
        <div class="modal-footer">   
            <input class="btn btn-primary" type="submit" Value="Save"/>
            <button type="button" class="btn btn-default" data-dismiss="modal">
                Cancel
            </button>
        </div>
        {% endif %}
        </form>
    </div>
</div>

<script type="text/javascript">
    $(document).ready(function(){
      $('#harvester-config-form').submit(function(ev) {
        ev.preventDefault();
        var serializedData = $(this).serialize();
        $.ajax({
            type: $(this).attr('method'),
            url: $(this).attr('action'),
            data: serializedData,
            context: this,
            success: function(response){
                $('#config-modal').modal('hide');
                console.log(response.changes);
                if (response.status == "Ok") {
                    var changes = "";
                    for (const [key, value] of Object.entries(response.changes)) {
                        changes += key + ":<br> before: " + value["before"] + ", after: " + value["after"] + "<br>";
                    }
                    $('#message-modal-header').text('Success!');
                    $('#message-modal-body').html("<p>" + response.message + "<br><br> Changed parameters: <br><br>" + changes + "</p>");
                } else if (response.status == "unchanged"){
                    $('#message-modal-header').text('Info');
                    $('#message-modal-body').text(response.message);
                }else {
                    $('#message-modal-header').text('Error!');
                    $('#message-modal-body').text(response.message);
                };
                $('#message-modal').modal('show');
            },  
            error: function (response) {
                $('#harvesterModal').modal('hide');
                $('#message-modal-header').text('Error!');
                $('#message-modal-body').text('There has been an internal error. Please contact an administrator.');
                $('#message-modal').modal('show');
            },    
        });
        return false;
      });
    });
    </script>  